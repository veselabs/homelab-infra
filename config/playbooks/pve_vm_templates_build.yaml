---
- name: Build VM templates
  hosts: pve
  connection: local
  run_once: true

  vars:
    debian_remote_url: "https://cdimage.debian.org\
      /images/cloud/trixie/latest/debian-13-genericcloud-amd64.qcow2"
    debian_local_path: /tmp/debian-13-genericcloud-amd64.qcow2
    debian_customized_local_path: /tmp/debian-13-genericcloud-amd64-customized.qcow2

  tasks:
    - name: Get base VM info
      register: base_vm_info
      community.proxmox.proxmox_vm_info:
        api_host: "{{ api_host }}"
        api_user: "{{ api_user }}"
        api_password: "{{ api_password }}"
        vmid: "{{ base_vmid }}"
        node: "{{ vm_templates_node }}"

    - name: Set has base VM info as fact
      ansible.builtin.set_fact:
        has_base_vm: >-
          {{
            base_vm_info.proxmox_vms
            | selectattr('vmid', '==', base_vmid)
            | length
            == 1
          }}

    - name: Create base VM
      when: not has_base_vm
      block:
        - name: Create bootstrap VM
          community.proxmox.proxmox_kvm:
            state: present
            api_host: "{{ api_host }}"
            api_user: "{{ api_user }}"
            api_password: "{{ api_password }}"
            vmid: "{{ bootstrap_vmid }}"
            name: bootstrap
            node: "{{ vm_templates_node }}"
            scsihw: virtio-scsi-pci
            net:
              net0: "virtio,bridge={{ interface }}"
            ide:
              ide0: "{{ storage }}:cloudinit"
            boot: order=scsi0
            agent: true

        - name: Get bootstrap VM info
          register: bootstrap_vm_info
          community.proxmox.proxmox_vm_info:
            api_host: "{{ api_host }}"
            api_user: "{{ api_user }}"
            api_password: "{{ api_password }}"
            node: "{{ vm_templates_node }}"
            vmid: "{{ bootstrap_vmid }}"
            config: current

        - name: Set bootstrap VM info as fact
          ansible.builtin.set_fact:
            bootstrap_vm: >-
              {{
                bootstrap_vm_info.proxmox_vms
                | selectattr('vmid', '==', bootstrap_vmid)
                | first
              }}

        - name: Attach Debian cloud image as disk
          when: bootstrap_vm.config.scsi0 is undefined
          block:
            - name: Download Debian cloud image
              connection: ssh
              delegate_to: "{{ vm_templates_node }}"
              ansible.builtin.get_url:
                url: "{{ debian_remote_url }}"
                dest: "{{ debian_local_path }}"
                mode: "0644"

            - name: Copy Debian cloud image for customization
              connection: ssh
              delegate_to: "{{ vm_templates_node }}"
              ansible.builtin.copy:
                remote_src: true
                src: "{{ debian_local_path }}"
                dest: "{{ debian_customized_local_path }}"
                mode: "0644"

            - name: Install libguestfs-tools
              connection: ssh
              delegate_to: "{{ vm_templates_node }}"
              ansible.builtin.apt:
                state: present
                name: libguestfs-tools

            - name: Customize Debian cloud image
              connection: ssh
              delegate_to: "{{ vm_templates_node }}"
              changed_when: true
              ansible.builtin.command: >-
                virt-customize
                  --add {{ debian_customized_local_path | quote }}
                  --install qemu-guest-agent
                  --truncate /etc/machine-id

            - name: Update bootstrap VM
              community.proxmox.proxmox_kvm:
                state: present
                api_host: "{{ api_host }}"
                api_user: "{{ api_user }}"
                api_password: "{{ api_password }}"
                vmid: "{{ bootstrap_vmid }}"
                node: "{{ vm_templates_node }}"
                scsi:
                  scsi0: "{{ storage }}:0,import-from={{ debian_customized_local_path }}"
                update: true
                update_unsafe: true

        - name: Build base VM
          changed_when: true
          ansible.builtin.command: >-
            packer build
              -var node={{ vm_templates_node | quote }}
              -var bootstrap_vm_id={{ bootstrap_vmid | quote }}
              -var base_vm_id={{ base_vmid | quote }}
              ../../images/base.pkr.hcl

        - name: Delete bootstrap VM
          community.proxmox.proxmox_kvm:
            state: absent
            api_host: "{{ api_host }}"
            api_user: "{{ api_user }}"
            api_password: "{{ api_password }}"
            node: "{{ vm_templates_node }}"
            vmid: "{{ bootstrap_vmid }}"
